/**
 *    Copyright 2022-2023 authID.ai (Ipsidy, Inc.)
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at

 *       http://www.apache.org/licenses/LICENSE-2.0

 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 */
class AuthIDComponent extends HTMLElement {
    connectedCallback() {
        const dataUrl = this.getAttribute('data-url');
        if (!dataUrl) {
            throw new Error('Missing data-url configuration!');
        }

        let dataTarget = this.getAttribute('data-target');

        if (!dataTarget || dataTarget === 'auto') {
            dataTarget = /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
        }

        const iframe = document.createElement('iframe');
        iframe.setAttribute('allow', 'fullscreen *;camera *;encrypted-media *;');
        iframe.setAttribute('src', dataUrl);
        
        const styleNode = document.createElement('style');
        styleNode.textContent = (
            'div, iframe {' +
              'position: fixed;' +
              'top: 0;' +
              'left: 0;' +
              'height: 100vh;' +
              'width: 100vw;' +
              'border: 0;' +
              'padding: 0;' +
              'margin: 0;' +
            '}'
        );

        const shadow = this.attachShadow({ mode: 'closed' });
        shadow.appendChild(styleNode);
        const container = document.createElement('div');
        shadow.appendChild(container);

        const dataWebauth = this.getAttribute('data-webauth');

        if (dataWebauth && dataWebauth !== 'false' && dataWebauth !== 'no') {
            const webauthHandler = document.createElement('script');
            webauthHandler.setAttribute('src', dataUrl.replace('/?', '/webauthhandler.js?'));
            shadow.appendChild(webauthHandler);
        }

        const dataControl = this.getAttribute('data-control');

        if (dataControl && dataControl !== 'false' && dataControl !== 'no') {
            const controlHandler = document.createElement('script');
            controlHandler.setAttribute('src', dataUrl.replace('/?', '/controlhandler.js?'));
            shadow.appendChild(controlHandler);
        }

        shadow.appendChild(iframe);

        iframe.addEventListener('load', () => {
            shadow.removeChild(container);

            shadow.dispatchEvent(new CustomEvent('load', {
                composed: true,
                bubbles: true,
            }));
        }, { capture: true, once: true });

        if (window.getComputedStyle(this)['z-index'] === 'auto') {
            this.style['z-index'] = 1000;
        }
    }
}

window.customElements.define('authid-component', AuthIDComponent);
